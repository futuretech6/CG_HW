# Project Proposal

<div align="right"><b>3180103012 陈希尧 (单人)</b></div>

[TOC]

## 功能说明

打算实现一个场景位于太空的探险游戏。玩家驾驶的核动力太空飞船误入了小行星带，而氧气即将耗尽，万幸的是小行星带有大量星际联盟的飞船留下的氧气罐，可以通过拾取氧气瓶来延长玩家的存活时间。若最终玩家能冲出小行星带则视作游戏胜利。

由于小行星带有大量小行星，在寻找并拾取氧气罐的同时得注意避让小行星，如果碰撞太多次飞船就会因破损而自爆，而碰到了会发光的热核小行星将直接导致飞船爆炸。注意，氧气消耗值在时间轴上是常量，因此将飞船减速虽然有利于避让小行星但是因缺氧而死的概率上升。

**控制说明**：

* W：拉杆抬升飞船
* S：推杆压低飞船
* A：飞船向左滚动
* D：飞船向右滚动
* Q：飞船向左偏航
* E：飞船向右偏航
* P：加速
* L：减速
* C：切换视角（第一人称固定/第一人称自由/第三人称自由）
    * 在第三人称自由视角下按键操作也改变
    * 在自由视角下可用拖动鼠标控制视角，滚动滚轮可以让视角靠近或远离

## 技术实现

### 游戏逻辑

绘制游戏的逻辑流程图如下：

```flow
st=>start: 开始
等待=>operation: 等待一个刷新周期
刷新=>operation: 进行计算并刷新屏幕
更新运动=>operation: 更新运动状态
更新属性=>operation: 更新属性状态
按键=>condition: 是否按下按键
碰撞=>condition: 是否发生碰撞
死亡=>condition: 是否缺氧或爆炸
离开=>condition: 是否离开小行星带
成功=>end: 游戏成功
失败=>end: 游戏失败

st->刷新->按键
按键(yes)->更新运动->碰撞
按键(no)->碰撞
碰撞(yes)->更新属性->死亡
碰撞(no)->死亡
死亡(yes)->失败
死亡(no)->离开
离开(yes)->成功
离开(no)->等待->刷新
```

### 飞船

#### 运动参数

对于飞船来说，需要记录的参数有：

* 空间一阶导：相对于小行星带的空间位置
* 空间二阶导：运动速度的大小，俯仰角（球坐标的$\varphi$）、翻滚角（相机的upVector）、偏航角（球坐标的$\theta$）
* 空间三阶导：游戏中将加速度和角加速度视作常量，按下控制键时会直接修改速度和速度方向

#### 运动过程

* 每隔一个刷新周期就可以根据当前的速度和方向数据来计算获得新的空间位置参数
* 每次刷新周期都检查按键的按下情况，如果有按下某个或某些按键，则更新对应的速度和方向参数；反之，则维持速度和方向不变（假设游戏环境是零重力环境）

#### 碰撞检测

小行星和氧气管可近似视作球体，飞船的话由于有尖锐突出部分，因此可以检查尖锐突出部分与宇宙漂浮物之间的距离，若小于半径则视为碰撞。

### 场景设置

#### 宇宙漂浮物

首先建立宇宙漂浮物的基类，这个基类应有的参数包括：

* 是否存在（如被碰撞过就需要置0了）
* 模型信息
* 空间位置
* 相对大小（相对模型的大小）
* 自转轴方向（球坐标）
* 自转速度
* （移动速度，有些麻烦，需要添加物体之间的碰撞检测，且电脑资源可能受不了）

在此基础上建立各种小行星和氧气瓶的派生类。

#### 场景控制

将位于不同位置的宇宙漂浮物用一个数据结构串起来，每次调用刷新函数时刷新状态即可。

#### 宇宙盒

用六张图片即可做成一个正方形的宇宙盒，然后将其设置为无限远处的场景，即可实现无边无际的宇宙的效果。

### 视角

#### 相机类

首先需要一个相机类，包含如下参数

* 相机的坐标（PRP）
* 相机视角的方向
* upVec（由于飞船可以翻滚，所以这是必要的）
* VRP
* Mode
    * 第一人称固定视角
    * 第一人称自由视角
    * 第三人称自由视角

#### 视角的变换

* 移动
    * 仅第三人称自由视角可以移动相机，直接改变相机的位置参数即可
* 旋转
    * 第一人称自由视角（相机始终朝向飞船）：当鼠标滑动时，由于飞船和相机的位置都有，因此实际上是在以飞船为球心，飞船和相机间距离为半径的球面上转动相机，同时保持相机朝向飞船，这个通过球坐标的变换可以很好地实现。
    * 第三人称自由视角（相机可以到处看）：当鼠标滑动，由于不要求相机朝向飞船，因此直接调节相机的朝向即可。
* 跟随
    * 仅有第一人称固定视角需要考虑跟随。跟随时，维持控制相机的朝向的$\theta$和$\varphi$与飞船的偏航角和俯仰角相同，upVector与飞船的翻滚角保持同步；PRP始终保持在飞船正后方某处，VRP始终保持在飞船正前方某处。
* 靠近/远离
    * 第一人称自由视角：修改相机位置使相机对应地远离或靠近飞船同时保持VRP仍在飞船即可，需要注意的是靠近的同时应该将视场角放大，反之缩小
    * 第三人称自由视角：要实现类似望远镜的效果，只需要缩小视场角，并沿视角方向拉远VRP即可。

### 光照

游戏中有两种光照，一种是宇宙盒发出的平行背景光，另一种是可近似认为是点光源的热核小行星发出的光。由于同一场景内可能会有多个这样的点光源存在，因此最后照到物体（飞船和漂浮物）的光是多个点光源和多束平行光的叠加。

## 可能的拓展

### 可玩性

1. 将小行星做成会移动的，需要加入额外的碰撞检测
2. 为玩家飞船加入带CD的武器，可以用以轰碎小行星
3. 在1和2的基础上，可以将小行星替换成带AI的同样携带武器的敌人飞船

### 画面

1. 实现光场的实时阴影（但是如果小行星太密集的话可能会很耗运算资源）